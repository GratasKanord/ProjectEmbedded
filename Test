#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>
#include <SPI.h>



#define SEALEVELPRESSURE_HPA (1013.25)

int color = 0;
const int sensorPin = 26;

// Motor A
int motor1Pin1 = 27;
int motor1Pin2 = 25;
int enable1Pin = 14;
bool buttonstate = 0;
// Setting PWM properties
const int freq = 30000;
const int pwmChannel = 0;
const int resolution = 8;
int dutyCycle = 200;

const int LED_START = 2;
const int LED_RIGHT = 5;
const int LED_LEFT = 15;

const int BUTTTON_RIGHT_PIN = 19;
const int BUTTTON_LEFT_PIN = 18;

int state = 0;
int isDoorOpen = 0;

unsigned long button_time = 0;
unsigned long last_button_time = 0;
const int timeBetweenPush = 200;

struct Button {
  const uint8_t PIN;
  bool pressed;
};

Button buttonRight = { BUTTTON_RIGHT_PIN, false };
Button buttonLeft = { BUTTTON_LEFT_PIN, false };

void IRAM_ATTR isrRight() {
  button_time = millis();
  if (button_time - last_button_time > timeBetweenPush) {
    buttonRight.pressed = true;

    if (state == 2) {
      state = 0;
    } else {
      state++;
    }

    manageLights();
    last_button_time = button_time;
  }
}

void IRAM_ATTR isrLeft() {
  button_time = millis();
  if (button_time - last_button_time > timeBetweenPush) {
    buttonLeft.pressed = true;
    if (state == 2) {
      state = 0;
    } else {
      state++;
    }

    manageLights();
    last_button_time = button_time;
  }
}



void setup() {
  Serial.begin(115200);
  pinMode(LED_START, OUTPUT);
  pinMode(LED_RIGHT, OUTPUT);
  pinMode(LED_LEFT, OUTPUT);

  pinMode(sensorPin, INPUT);

  attachInterrupt(buttonRight.PIN, isrRight, FALLING);
  attachInterrupt(buttonLeft.PIN, isrLeft, FALLING);

  bool status;


  // sets the pins as outputs:
  pinMode(motor1Pin1, OUTPUT);
  pinMode(motor1Pin2, OUTPUT);
  pinMode(enable1Pin, OUTPUT);

  // configure LED PWM functionalitites
  ledcSetup(pwmChannel, freq, resolution);

  // attach the channel to the GPIO to be controlled
  ledcAttachPin(enable1Pin, pwmChannel);
}

void manageLights() {

  switch (state) {
    case 0:
      digitalWrite(LED_START, LOW);
      digitalWrite(LED_RIGHT, LOW);
      digitalWrite(LED_LEFT, LOW);
      break;

    case 1:
      digitalWrite(LED_START, HIGH);
      break;

    case 2:
      digitalWrite(LED_START, LOW);
      if (buttonRight.pressed) {
        digitalWrite(LED_RIGHT, HIGH);
      }

      if (buttonLeft.pressed) {
        digitalWrite(LED_LEFT, HIGH);
      }
      break;
  }
  buttonLeft.pressed = false;
  buttonRight.pressed = false;
}



void loop() {


  //int tempState = map(bme.readTemperature(), 23, 28, 0, 2);

  color = analogRead(sensorPin);
  Serial.println(color);
  if (color > 3500) {
    Serial.println("Moving Forward");
    digitalWrite(motor1Pin1, LOW);
    digitalWrite(motor1Pin2, HIGH);
    delay(1200);
    digitalWrite(motor1Pin1, LOW);
    digitalWrite(motor1Pin2, LOW);
    delay(3000);
    
    Serial.println("Moving Backwards");
    digitalWrite(motor1Pin1, HIGH);
    digitalWrite(motor1Pin2, LOW);
    delay(800);
    ledcWrite(pwmChannel, dutyCycle);
    dutyCycle = 200;
    digitalWrite(motor1Pin1, LOW);
    digitalWrite(motor1Pin2, LOW);
  }
}
